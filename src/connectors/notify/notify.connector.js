const { NotifyClient } = require("notifications-node-client");
const { notifyClientDouble } = require("./notify.double");
const { NOTIFY_KEY } = require("../../config");
const { logEmitter } = require("../../services/logging.service");
const { pdfGenerator } = require("../../services/pdf.service");

const sendSingleEmail = async (templateId, recipientEmail, flattenedData) => {
  logEmitter.emit("functionCall", "notify.connector", "sendSingleEmail");

  let notifyClient;

  if (process.env.DOUBLE_MODE === "true") {
    logEmitter.emit("doubleMode", "notify.connector", "sendSingleEmail");
    notifyClient = notifyClientDouble;
  } else {
    notifyClient = new NotifyClient(NOTIFY_KEY);
  }

  //const pdf_file = await pdfGenerator();

  const pdf_file =
    "JVBERi0xLjMKJf////8KNiAwIG9iago8PAovVHlwZSAvRXh0R1N0YXRlCi9jYSAxCj4+CmVuZG9iago1IDAgb2JqCjw8Ci9UeXBlIC9QYWdlCi9QYXJlbnQgMSAwIFIKL01lZGlhQm94IFswIDAgNTk1LjI4IDg0MS44OV0KL0NvbnRlbnRzIDMgMCBSCi9SZXNvdXJjZXMgNCAwIFIKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCi9FeHRHU3RhdGUgPDwKL0dzMSA2IDAgUgo+PgovRm9udCA8PAovRjIgNyAwIFIKL0YzIDggMCBSCj4+Cj4+CmVuZG9iago5IDAgb2JqCjw8Ci9Qcm9kdWNlciAocGRmbWFrZSkKL0NyZWF0b3IgKHBkZm1ha2UpCi9DcmVhdGlvbkRhdGUgKEQ6MjAxODEwMjkxMDU1NTdaKQo+PgplbmRvYmoKMTEgMCBvYmoKPDwKL1R5cGUgL0ZvbnREZXNjcmlwdG9yCi9Gb250TmFtZSAvTlNDRk1KK1JvYm90by1SZWd1bGFyCi9GbGFncyA0Ci9Gb250QkJveCBbLTczNi44MTY0MDYgLTI3MC45OTYwOTQgMTE0OC40Mzc1IDEwNTYuMTUyMzQ0XQovSXRhbGljQW5nbGUgMAovQXNjZW50IDkyNy43MzQzNzUKL0Rlc2NlbnQgLTI0NC4xNDA2MjUKL0NhcEhlaWdodCA3MTAuOTM3NQovWEhlaWdodCA1MjguMzIwMzEzCi9TdGVtViAwCi9Gb250RmlsZTIgMTAgMCBSCj4+CmVuZG9iagoxMiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvQ0lERm9udFR5cGUyCi9CYXNlRm9udCAvTlNDRk1KK1JvYm90by1SZWd1bGFyCi9DSURTeXN0ZW1JbmZvIDw8Ci9SZWdpc3RyeSAoQWRvYmUpCi9PcmRlcmluZyAoSWRlbnRpdHkpCi9TdXBwbGVtZW50IDAKPj4KL0ZvbnREZXNjcmlwdG9yIDExIDAgUgovVyBbMCBbOTA4IDYwMC41ODU5MzggNTcwLjMxMjUgNTUxLjI2OTUzMSAzMzguMzc4OTA2IDI0Ny41NTg1OTQgNTUxLjc1NzgxMyAyNDIuNjc1NzgxIDU2OC4zNTkzNzUgNTI5Ljc4NTE1NiAzNDcuMTY3OTY5IDU2My45NjQ4NDQgNTYxLjAzNTE1NiA1MTUuNjI1IDU2MS4wMzUxNTYgMzI2LjY2MDE1NiA1NDMuOTQ1MzEzIDg3Ni40NjQ4NDQgNjg3LjUgNTYxLjAzNTE1NiA0NzMuMTQ0NTMxXV0KPj4KZW5kb2JqCjcgMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUwCi9CYXNlRm9udCAvTlNDRk1KK1JvYm90by1SZWd1bGFyCi9FbmNvZGluZyAvSWRlbnRpdHktSAovRGVzY2VuZGFudEZvbnRzIFsxMiAwIFJdCi9Ub1VuaWNvZGUgMTMgMCBSCj4+CmVuZG9iagoxNSAwIG9iago8PAovVHlwZSAvRm9udERlc2NyaXB0b3IKL0ZvbnROYW1lIC9XRkRQQlcrUm9ib3RvLU1lZGl1bQovRmxhZ3MgNAovRm9udEJCb3ggWy03MzIuNDIxODc1IC0yNzAuOTk2MDk0IDExNjkuOTIxODc1IDEwNTYuMTUyMzQ0XQovSXRhbGljQW5nbGUgMAovQXNjZW50IDkyNy43MzQzNzUKL0Rlc2NlbnQgLTI0NC4xNDA2MjUKL0NhcEhlaWdodCA3MTAuOTM3NQovWEhlaWdodCA1MjguMzIwMzEzCi9TdGVtViAwCi9Gb250RmlsZTIgMTQgMCBSCj4+CmVuZG9iagoxNiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvQ0lERm9udFR5cGUyCi9CYXNlRm9udCAvV0ZEUEJXK1JvYm90by1NZWRpdW0KL0NJRFN5c3RlbUluZm8gPDwKL1JlZ2lzdHJ5IChBZG9iZSkKL09yZGVyaW5nIChJZGVudGl0eSkKL1N1cHBsZW1lbnQgMAo+PgovRm9udERlc2NyaXB0b3IgMTUgMCBSCi9XIFswIFs5MDggNTQ5LjMxNjQwNiA1NjguMzU5Mzc1IDYzMC4zNzEwOTQgNTY1LjQyOTY4OCA2OTAuNDI5Njg4IDI0OS4wMjM0MzggMzI4LjEyNSA2ODAuNjY0MDYzIDU2OC4zNTkzNzUgNTU1LjE3NTc4MSA2MDMuNTE1NjI1IDg3NS40ODgyODEgNzA5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/2rjvWPxDP7BCWOd3NuEA8YCVOq9cPKMQUvMqd2Jn1ydIOK8vc6eHjl5GjH5+tZ6naqcOrl3X95W7xlOn57vsO6GKud+vj7tP5nNP9v35D67m+/3f/4y7X9+99ZPjy4GkJQTKkssOVJBH0MiIEXhEqGkqNmWpODpRv84/eZu3j2C//ToDhfvBF8/dcfB/e5gjdm3m7YOPkdTJ5MUr5wDFxNDfvPgbn5ET8lvDu7DdzFGuPUEQSljBl8X0AbZYBty6+NHv3nvfti4n/4VGkhojKiY0l04VXKyoTZyuy9DkaBmW6QSUx/JXeOiju1QBJQgpFSwaB/B1PTfNT5S42LXxkDrgIYkWUS8xhTIjL+KiG99CahKzLOvVDT7hq4iOix7oAQhQKl7ILZ1bVymsVzGHFLRBNpHnhYuARqvZbiHM8dAlkueQzJzNUxqsihPUlS92e/Mlegsyi8Du13TOBcqGhRTAe4j0aFSEXKQyCi5LzU3k981vbeNk3FISLhGRiryLfUnlRBFrL70pUqz/dQCFZ5xwji/f0HxrX65IsSiF7XKSjmyHrWE8qTlfkk1VTmwugYcEmemPOchc3+gy0VuKaFnkZdhBPPIIoWVulhBGk5q0CxBgfkG5DMka51SLWEaagGzDCtRTOgf+6/aD2k9Bi89h/jrlnr9x0gzkhVhtrKDxwx5Qg0utCw5eq2a1CqkSdKyNie253L5y41o1sjWkPWQzs7GR7TDpFO0asxfST5z9W2TrI2TcQ5MbORGYispPQSz464GmXyJwKsgrfs4gQSFrP9fF48m21g6Rv9/2MV7SGOrltt/aP92L6gk17v+BaIz158af+VV8jcly61stDyDorp+CinOBfdoUoMCd0PhsIVBKtZXUhcObE8QVGLyWFIiBjvy1vMB2/EJWRnXstJIibMjdKVVE1j7K/NZbq7mlwvT4MxYT/6Qn2EBds0xWzJ8JTuIhJJBy5pzjrdDT9pRX7PHm2wHH0u2818JsG99zWFJYK9EBJEVirReJscT0ZO2W4yPFoSIY6VLCQScY19fNPKxRoEGMSMsxQOvLRrrhZgxWhNAr16I/wbGWldOCmVuZHN0cmVhbQplbmRvYmoKeHJlZgowIDE4CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMjI3NiAwMDAwMCBuIAowMDAwMDAyMjI3IDAwMDAwIG4gCjAwMDAwMTA2NjMgMDAwMDAgbiAKMDAwMDAwMDE2OSAwMDAwMCBuIAowMDAwMDAwMDU5IDAwMDAwIG4gCjAwMDAwMDAwMTUgMDAwMDAgbiAKMDAwMDAwMTA2NiAwMDAwMCBuIAowMDAwMDAyMDgwIDAwMDAwIG4gCjAwMDAwMDAyOTYgMDAwMDAgbiAKMDAwMDAwMzA2OCAwMDAwMCBuIAowMDAwMDAwMzkwIDAwMDAwIG4gCjAwMDAwMDA2NTYgMDAwMDAgbiAKMDAwMDAwMjMzMyAwMDAwMCBuIAowMDAwMDA2MTUwIDAwMDAwIG4gCjAwMDAwMDEyMTQgMDAwMDAgbiAKMDAwMDAwMTQ4MSAwMDAwMCBuIAowMDAwMDAyNjgyIDAwMDAwIG4gCnRyYWlsZXIKPDwKL1NpemUgMTgKL1Jvb3QgMiAwIFIKL0luZm8gOSAwIFIKPj4Kc3RhcnR4cmVmCjExNjM0CiUlRU9GCg==";
  flattenedData.link_to_document = notifyClient.prepareUpload(pdf_file);

  try {
    const notifyArguments = [
      templateId,
      recipientEmail,
      { personalisation: flattenedData }
    ];

    const notifyResponse = await notifyClient.sendEmail(...notifyArguments);
    const responseBody = notifyResponse.body;
    logEmitter.emit("functionSuccess", "notify.connector", "sendSingleEmail");
    return responseBody;
  } catch (err) {
    const newError = new Error("Notify error");
    if (err.message === "secretOrPrivateKey must have a value") {
      newError.name = "notifyMissingKey";
    }
    if (err.statusCode === 400) {
      if (err.error.errors[0].error === "ValidationError") {
        newError.name = "notifyInvalidTemplate";
        newError.message = err.message;
      }
      if (err.error.errors[0].error === "BadRequestError") {
        newError.name = "notifyMissingPersonalisation";
        newError.message = err.message;
      }
    }
    logEmitter.emit(
      "functionFail",
      "notify.connector",
      "sendSingleEmail",
      newError
    );
    throw newError;
  }
};

module.exports = { sendSingleEmail };
